# HDFS

## Architecture

하나의 네임노드, 여러 개의 데이터노드로 구성됨.

### 1. 네임노드

네임노드의 주요 역할은 메타데이터 관리와 데이터노드의 관리

#### 1.1 메타데이터 관리

메타데이터는 파일이름, 파일크기, 파일생성시간, 파일접근권한, 파일 소유자 및 그룹 소유자, 파일이 위치한 블록의 정보 등으로 구성됨. 각 데이터노드에서 전달하는 메타데이터를 받아서 전체 노드의 메타데이터 정보와 파일 정보를 묶어서 관리함.

메타데이터는 사용자가 설정한 위치(`dfs.name.dir`)에 보관됨. 네임노드가 실행될 때 파일을 읽어서 메모리에 보관함. 운영중에 발생한 수정사항은 네임노드의 메모리에는 바로 적용되고, 데이터의 수정 사항을 다음 구동 시 적용을 위해 주기적으로 Edits 파일로 저장함.

- 메타데이터 파일 종류
  - Fsimage 파일
    - 네임스페이스와 블록정보
  - Edits 파일
    - 파일의 생성, 삭제에 대한 트랜잭션 로그
    - 메모리에 저장하다가 주기적으로 생성

- 메타데이터 파일 저장 형태
  - 사용자가 설정한 위치(dfs.name.dir)에 다음과 같은 파일의 형태로 저장됨.

```bash
# 네임노드의 메타 데이터가 다음과 같은 형태로 생성됨  
-rw-r--r-- 1 hdfs hdfs 439M May 29 05:25 edits_0000000000385503885-0000000000387505111
-rw-r--r-- 1 hdfs hdfs 456M May 30 08:25 edits_0000000000387505112-0000000000389525762
-rw-r--r-- 1 hdfs hdfs  10M May 31 01:02 edits_inprogress_0000000000389525763
-rw-r--r-- 1 hdfs hdfs  346 Nov 23  2017 fsimage_0000000000000000000
-rw-r--r-- 1 hdfs hdfs   62 Nov 23  2017 fsimage_0000000000000000000.md5
```

#### 1.2 데이터노드 관리

네임노드는 데이터노드가 주기적으로 전달하는 heartbeat(3초, `dfs.heartbeat.interval`)와 블록리포트(6시간, `dfs.blockreport.intervalMsec`)를 이용하여 데이터 노드의 동작상태, 블록 상태를 관리함.

하트비트를 이용하여 데이터노드가 동작 중이라는 것을 네임노드가 알 수 있음. 하트비트가 도착하지 않으면 네임노드는 데이터노드가 동작 하지 않는 것으로 간주, 더 이상 IO가 발생하지 않도록 조치함.

블록리포트를 이용하여 HDFS에 저장된 파일에 대한 최신 정보를 유지함. 블록리포트에는 데이터노드에 저장된 블록 목록과 각 블록이 로컬 디스크의 어디에 저장되어 있는지에 대한 정보를 가지고 있음.

### 2. 데이터 노드

데이터노드는 파일을 저장하는 역할을 함. 파일은 블록 단위로 저장됨. 데이터노드는 주기적으로 네임노드에 하트비트와 블록리포트를 전달함. 하트비트는 데이터노드의 동작여부를 판단하는데 이용됨. 블록리포트로 블록의 변경사항을 체크하고, 네임노드의 메타데이터를 갱신함.

#### 블록 파일 저장형태
사용자가 설정한 위치(`dfs.data.dir`)에 다음과 같은 파일의 형태로 저장됨.

```bash
./hdfs/current/BP-11233441/current/finalized/subdir187/subdir191:
total 676K
drwxr-xr-x   2 hdfs hdfs 4.0K Sep  8 04:30 .
drwxr-xr-x 258 hdfs hdfs 8.0K Aug 31 22:21 ..
-rw-r--r--   1 hdfs hdfs  40K Aug 31 22:46 blk_12345
-rw-r--r--   1 hdfs hdfs  327 Aug 31 22:46 blk_12345_29082353.meta
-rw-r--r--   1 hdfs hdfs  19K Aug 31 22:46 blk_12346
-rw-r--r--   1 hdfs hdfs  155 Aug 31 22:46 blk_12346_29082375.meta
-rw-r--r--   1 hdfs hdfs 262K Aug 31 22:46 blk_12347
-rw-r--r--   1 hdfs hdfs 2.1K Aug 31 22:46 blk_12347_29082433.meta
```

#### 데이터노드 상태

데이터 노드의 상태를 나타내는 정보는 두 가지로 구분할 수 있음. 첫번째 유형은 활성 상태. 두번째 유형은 서비스가 운영 중인지를 나타냄.

- 활성 상태
  - 활성 상태는 데이터 노드가 live 상태인지 dead 상태인지를 나타냄. 데이터노드가 하트비트를 주기적으로 전달하여 살아 있는지 확인되면 live. 문제가 생겨서 지정한 시간동안(`dfs.namenode.stale.datanode.interval`) 하트비트를 받지 못하면 네임노드는 데이터노드의 상태를 stale 로 변경함. 이후 지정한 시간동안 응답이 없으면 dead 노드로 변경함.

- 운영 상태
  - 운영 상태는 데이터노드의 업그레이드, 패치 같은 작업을 하기 위해 서비스를 잠시 멈추어야 할 경우 블록을 안전하게 보관하기 위해 설정함. 다음의 상태가 있음.
    - NORMAL: 서비스 상태
    - DECOMMISSIONED: 서비스 중단 상태
    - DECOMMISSION_INPROGRESS: 서비스 중단 상태로 진행 중
    - IN_MAINTENANCE: 정비 상태
    - ENTERING_MAINTENANCE: 정비 상태로 진행 중
  - `dfs.hosts`파일(datanode admin)에 노드의 상태를 json형태로 기술하여 운영 중에 서비스를 잠시 멈추고 정비를 한 후 다시 진행할 수 있음.


### 3. 네임노드 구동 과정

> 1. Fsimage를 읽어 메모리에 적재
> 2. Edits 파일을 읽어와서 변경내역을 반영
> 3. 현재의 메모리 상태를 스냅샷으로 생성하여 Fsimage 파일 생성
> 4. 데이터 노드로부터 블록리포트를 수신하여 매핑정보 생성
> 5. 서비스 시작

### 4. 파일 읽기/쓰기

HDFS의 파일에 접근하는 가장 간단한 방법은 HDFS 명령행 인터페이스(CLI)를 이용하는 것임. 또한 Java, C API 를 제공하여 이를 구현해서 접근하면 됨.

#### 4.1 파일 읽기

1. 네임노드에 파일이 보관된 블록 위치 요청
2. 네임노드가 블록 위치 반환
3. 각 데이터 노드에 파일 블록을 요청
4. 노드의 블록이 꺠져 있으면 네임노드에 이를 통지하고 다른 블록 확인


#### 4.2 파일 쓰기

1. 네임노드에 파일 정보를 전송하고, 파일의 블록을 써야할 노드 목록 요청
2. 네임노드가 파일을 저장할 노드 목록 반환
3. 데이터 노드에 파일 쓰기 요청
4. 데이터 노드간 복제가 진행